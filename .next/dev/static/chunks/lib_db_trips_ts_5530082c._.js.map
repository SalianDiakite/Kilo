{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Projet-01/projet-perso/Kilo/lib/db/trips.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/client\"\r\nimport type { DbTrip, DbTripInsert, DbTripUpdate } from \"./types\"\r\n\r\nconst PUBLIC_USER_COLUMNS =\r\n  \"id, name, avatar, bio, rating, review_count, verified, languages, response_rate, response_time, created_at\"\r\n\r\nexport interface TripFilters {\r\n  departure?: string\r\n  arrival?: string\r\n  departureCountry?: string\r\n  arrivalCountry?: string\r\n  dateFrom?: string\r\n  dateTo?: string\r\n  minKg?: number\r\n  maxPrice?: number\r\n  status?: string\r\n}\r\n\r\n// Client-side\r\nexport async function getTrips(filters?: TripFilters, page = 1, limit = 10) {\r\n  const supabase = createClient()\r\n  let query = supabase\r\n    .from(\"trips\")\r\n    .select(`*, user:profiles(${PUBLIC_USER_COLUMNS})`, { count: \"exact\" })\r\n    .order(\"created_at\", { ascending: false })\r\n\r\n  if (filters?.departure) {\r\n    query = query.ilike(\"departure\", `%${filters.departure}%`)\r\n  }\r\n  if (filters?.arrival) {\r\n    query = query.ilike(\"arrival\", `%${filters.arrival}%`)\r\n  }\r\n  if (filters?.departureCountry) {\r\n    query = query.eq(\"departure_country\", filters.departureCountry)\r\n  }\r\n  if (filters?.arrivalCountry) {\r\n    query = query.eq(\"arrival_country\", filters.arrivalCountry)\r\n  }\r\n  if (filters?.dateFrom) {\r\n    query = query.gte(\"departure_date\", filters.dateFrom)\r\n  }\r\n  if (filters?.dateTo) {\r\n    query = query.lte(\"departure_date\", filters.dateTo)\r\n  }\r\n  if (filters?.minKg) {\r\n    query = query.gte(\"available_kg\", filters.minKg)\r\n  }\r\n  if (filters?.maxPrice) {\r\n    query = query.lte(\"price_per_kg\", filters.maxPrice)\r\n  }\r\n  if (filters?.status) {\r\n    query = query.eq(\"status\", filters.status)\r\n  } else {\r\n    query = query.eq(\"status\", \"active\")\r\n  }\r\n\r\n  const from = (page - 1) * limit\r\n  const to = from + limit - 1\r\n  query = query.range(from, to)\r\n\r\n  const { data, error, count } = await query\r\n\r\n  if (error) throw error\r\n  return { trips: data as DbTrip[], total: count || 0 }\r\n}\r\n\r\nexport async function getTrip(tripId: string) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase.from(\"trips\").select(`*, user:profiles(${PUBLIC_USER_COLUMNS})`).eq(\"id\", tripId).single()\r\n\r\n  if (error) throw error\r\n  return data as DbTrip\r\n}\r\n\r\nexport async function getUserTrips(userId: string, filters?: TripFilters) {\r\n  const supabase = createClient()\r\n  let query = supabase\r\n    .from(\"trips\")\r\n    .select(`*, user:profiles(${PUBLIC_USER_COLUMNS})`)\r\n    .eq(\"user_id\", userId)\r\n    .order(\"created_at\", { ascending: false })\r\n\r\n  if (filters?.status) {\r\n    query = query.eq(\"status\", filters.status)\r\n  }\r\n  if (filters?.dateFrom) {\r\n    query = query.gte(\"created_at\", filters.dateFrom)\r\n  }\r\n  if (filters?.dateTo) {\r\n    query = query.lte(\"created_at\", filters.dateTo)\r\n  }\r\n\r\n  const { data, error } = await query\r\n\r\n  if (error) throw error\r\n  return data as DbTrip[]\r\n}\r\n\r\nexport async function createTrip(trip: DbTripInsert) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase.from(\"trips\").insert(trip).select(`*, user:profiles(${PUBLIC_USER_COLUMNS})`).single()\r\n\r\n  if (error) throw error\r\n  return data as DbTrip\r\n}\r\n\r\nexport async function updateTrip(tripId: string, updates: DbTripUpdate) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from(\"trips\")\r\n    .update({ ...updates, updated_at: new Date().toISOString() })\r\n    .eq(\"id\", tripId)\r\n    .select(`*, user:profiles(${PUBLIC_USER_COLUMNS})`)\r\n    .single()\r\n\r\n  if (error) throw error\r\n  return data as DbTrip\r\n}\r\n\r\nexport async function deleteTrip(tripId: string) {\r\n  const supabase = createClient()\r\n  const { error } = await supabase.from(\"trips\").delete().eq(\"id\", tripId)\r\n\r\n  if (error) throw error\r\n}\r\n\r\nexport async function incrementTripViews(tripId: string) {\r\n  const supabase = createClient()\r\n  const { error } = await supabase.rpc(\"increment_trip_views\", { trip_id: tripId })\r\n  if (error) {\r\n    // Fallback si la fonction RPC n'existe pas\r\n    const { data: trip } = await supabase.from(\"trips\").select(\"views\").eq(\"id\", tripId).single()\r\n\r\n    if (trip) {\r\n      await supabase\r\n        .from(\"trips\")\r\n        .update({ views: (trip.views || 0) + 1 })\r\n        .eq(\"id\", tripId)\r\n    }\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}