{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Projet-01/projet-perso/Kilo/lib/db/reviews.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/client\"\r\nimport type { DbReview, DbReviewInsert } from \"./types\"\r\n\r\nexport async function getReviews(userId: string, type: \"received\" | \"given\") {\r\n  const supabase = createClient()\r\n\r\n  const column = type === \"received\" ? \"reviewed_id\" : \"reviewer_id\"\r\n\r\n  const { data, error } = await supabase\r\n    .from(\"reviews\")\r\n    .select(\"*, reviewer:profiles!reviewer_id(*), reviewed:profiles!reviewed_id(*), trip:trips(*)\")\r\n    .eq(column, userId)\r\n    .order(\"created_at\", { ascending: false })\r\n\r\n  if (error) throw error\r\n  return data as DbReview[]\r\n}\r\n\r\nexport async function createReview(review: DbReviewInsert) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from(\"reviews\")\r\n    .insert(review)\r\n    .select(\"*, reviewer:profiles!reviewer_id(*), reviewed:profiles!reviewed_id(*)\")\r\n    .single()\r\n\r\n  if (error) throw error\r\n\r\n  // Mettre à jour la note moyenne du profil\r\n  await updateUserRating(review.reviewed_id)\r\n\r\n  return data as DbReview\r\n}\r\n\r\nasync function updateUserRating(userId: string) {\r\n  const supabase = createClient()\r\n\r\n  // Calculer la nouvelle note moyenne\r\n  const { data: reviews } = await supabase.from(\"reviews\").select(\"rating\").eq(\"reviewed_id\", userId)\r\n\r\n  if (reviews && reviews.length > 0) {\r\n    const avgRating = reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length\r\n\r\n    await supabase\r\n      .from(\"profiles\")\r\n      .update({\r\n        rating: Math.round(avgRating * 10) / 10,\r\n        review_count: reviews.length,\r\n      })\r\n      .eq(\"id\", userId)\r\n  }\r\n}\r\n\r\nexport async function deleteReview(reviewId: string) {\r\n  const supabase = createClient()\r\n\r\n  // Récupérer le reviewed_id avant de supprimer\r\n  const { data: review } = await supabase.from(\"reviews\").select(\"reviewed_id\").eq(\"id\", reviewId).single()\r\n\r\n  const { error } = await supabase.from(\"reviews\").delete().eq(\"id\", reviewId)\r\n\r\n  if (error) throw error\r\n\r\n  // Mettre à jour la note moyenne\r\n  if (review) {\r\n    await updateUserRating(review.reviewed_id)\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAGO,eAAe,WAAW,MAAc,EAAE,IAA0B;IACzE,MAAM,WAAW,IAAA,yIAAY;IAE7B,MAAM,SAAS,SAAS,aAAa,gBAAgB;IAErD,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,WACL,MAAM,CAAC,wFACP,EAAE,CAAC,QAAQ,QACX,KAAK,CAAC,cAAc;QAAE,WAAW;IAAM;IAE1C,IAAI,OAAO,MAAM;IACjB,OAAO;AACT;AAEO,eAAe,aAAa,MAAsB;IACvD,MAAM,WAAW,IAAA,yIAAY;IAC7B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,WACL,MAAM,CAAC,QACP,MAAM,CAAC,yEACP,MAAM;IAET,IAAI,OAAO,MAAM;IAEjB,0CAA0C;IAC1C,MAAM,iBAAiB,OAAO,WAAW;IAEzC,OAAO;AACT;AAEA,eAAe,iBAAiB,MAAc;IAC5C,MAAM,WAAW,IAAA,yIAAY;IAE7B,oCAAoC;IACpC,MAAM,EAAE,MAAM,OAAO,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,WAAW,MAAM,CAAC,UAAU,EAAE,CAAC,eAAe;IAE5F,IAAI,WAAW,QAAQ,MAAM,GAAG,GAAG;QACjC,MAAM,YAAY,QAAQ,MAAM,CAAC,CAAC,KAAK,IAAM,MAAM,EAAE,MAAM,EAAE,KAAK,QAAQ,MAAM;QAEhF,MAAM,SACH,IAAI,CAAC,YACL,MAAM,CAAC;YACN,QAAQ,KAAK,KAAK,CAAC,YAAY,MAAM;YACrC,cAAc,QAAQ,MAAM;QAC9B,GACC,EAAE,CAAC,MAAM;IACd;AACF;AAEO,eAAe,aAAa,QAAgB;IACjD,MAAM,WAAW,IAAA,yIAAY;IAE7B,8CAA8C;IAC9C,MAAM,EAAE,MAAM,MAAM,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,WAAW,MAAM,CAAC,eAAe,EAAE,CAAC,MAAM,UAAU,MAAM;IAEvG,MAAM,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,WAAW,MAAM,GAAG,EAAE,CAAC,MAAM;IAEnE,IAAI,OAAO,MAAM;IAEjB,gCAAgC;IAChC,IAAI,QAAQ;QACV,MAAM,iBAAiB,OAAO,WAAW;IAC3C;AACF"}}]
}