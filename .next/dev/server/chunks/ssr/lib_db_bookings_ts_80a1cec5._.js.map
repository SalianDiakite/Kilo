{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Projet-01/projet-perso/Kilo/lib/db/bookings.ts"],"sourcesContent":["import { createClient } from \"@/lib/supabase/client\"\r\nimport type { DbBooking, DbBookingInsert, DbBookingUpdate } from \"./types\"\r\n\r\nexport interface BookingFilters {\r\n  dateFrom?: string\r\n  dateTo?: string\r\n}\r\n\r\nexport async function getBooking(bookingId: string) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from(\"bookings\")\r\n    .select(\"*, sender:profiles(*), trip:trips(*, user:profiles(*))\")\r\n    .eq(\"id\", bookingId)\r\n    .single()\r\n\r\n  if (error) throw error\r\n  return data as DbBooking\r\n}\r\n\r\nexport async function getTripBookings(tripId: string) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from(\"bookings\")\r\n    .select(\"*, sender:profiles(*)\")\r\n    .eq(\"trip_id\", tripId)\r\n    .order(\"created_at\", { ascending: false })\r\n\r\n  if (error) throw error\r\n  return data as DbBooking[]\r\n}\r\n\r\nexport async function getUserBookings(userId: string, role: \"sender\" | \"owner\", filters?: BookingFilters) {\r\n  const supabase = createClient()\r\n\r\n  if (role === \"sender\") {\r\n    let query = supabase\r\n      .from(\"bookings\")\r\n      .select(\"*, trip:trips(*, user:profiles(*))\")\r\n      .eq(\"sender_id\", userId)\r\n      .order(\"created_at\", { ascending: false })\r\n\r\n    if (filters?.dateFrom) {\r\n      query = query.gte(\"created_at\", filters.dateFrom)\r\n    }\r\n    if (filters?.dateTo) {\r\n      query = query.lte(\"created_at\", filters.dateTo)\r\n    }\r\n\r\n    const { data, error } = await query\r\n\r\n    if (error) throw error\r\n    return data as DbBooking[]\r\n  } else {\r\n    // Pour le propriétaire, récupérer toutes les réservations de ses trajets\r\n    let query = supabase\r\n      .from(\"bookings\")\r\n      .select(\"*, sender:profiles(*), trip:trips!inner(*)\")\r\n      .eq(\"trip.user_id\", userId)\r\n      .order(\"created_at\", { ascending: false })\r\n\r\n    if (filters?.dateFrom) {\r\n      query = query.gte(\"created_at\", filters.dateFrom)\r\n    }\r\n    if (filters?.dateTo) {\r\n      query = query.lte(\"created_at\", filters.dateTo)\r\n    }\r\n\r\n    const { data, error } = await query\r\n\r\n    if (error) throw error\r\n    return data as DbBooking[]\r\n  }\r\n}\r\n\r\nexport async function createBooking(booking: DbBookingInsert) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from(\"bookings\")\r\n    .insert(booking)\r\n    .select(\"*, sender:profiles(*), trip:trips(*, user:profiles(*))\")\r\n    .single()\r\n\r\n  if (error) throw error\r\n  return data as DbBooking\r\n}\r\n\r\nexport async function updateBooking(bookingId: string, updates: DbBookingUpdate) {\r\n  const supabase = createClient()\r\n  const { data, error } = await supabase\r\n    .from(\"bookings\")\r\n    .update({ ...updates, updated_at: new Date().toISOString() })\r\n    .eq(\"id\", bookingId)\r\n    .select(\"*, sender:profiles(*), trip:trips(*, user:profiles(*))\")\r\n    .single()\r\n\r\n  if (error) throw error\r\n  return data as DbBooking\r\n}\r\n\r\nexport async function cancelBooking(bookingId: string) {\r\n  return updateBooking(bookingId, { status: \"cancelled\" })\r\n}\r\n\r\nexport async function confirmBooking(bookingId: string, kgConfirmed?: number) {\r\n  const updates: DbBookingUpdate = { status: \"confirmed\" }\r\n  if (kgConfirmed !== undefined) {\r\n    updates.kg_confirmed = kgConfirmed\r\n  }\r\n  return updateBooking(bookingId, updates)\r\n}\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;;AAQO,eAAe,WAAW,SAAiB;IAChD,MAAM,WAAW,IAAA,yIAAY;IAC7B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CAAC,0DACP,EAAE,CAAC,MAAM,WACT,MAAM;IAET,IAAI,OAAO,MAAM;IACjB,OAAO;AACT;AAEO,eAAe,gBAAgB,MAAc;IAClD,MAAM,WAAW,IAAA,yIAAY;IAC7B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CAAC,yBACP,EAAE,CAAC,WAAW,QACd,KAAK,CAAC,cAAc;QAAE,WAAW;IAAM;IAE1C,IAAI,OAAO,MAAM;IACjB,OAAO;AACT;AAEO,eAAe,gBAAgB,MAAc,EAAE,IAAwB,EAAE,OAAwB;IACtG,MAAM,WAAW,IAAA,yIAAY;IAE7B,IAAI,SAAS,UAAU;QACrB,IAAI,QAAQ,SACT,IAAI,CAAC,YACL,MAAM,CAAC,sCACP,EAAE,CAAC,aAAa,QAChB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM;QAE1C,IAAI,SAAS,UAAU;YACrB,QAAQ,MAAM,GAAG,CAAC,cAAc,QAAQ,QAAQ;QAClD;QACA,IAAI,SAAS,QAAQ;YACnB,QAAQ,MAAM,GAAG,CAAC,cAAc,QAAQ,MAAM;QAChD;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM;QAE9B,IAAI,OAAO,MAAM;QACjB,OAAO;IACT,OAAO;QACL,yEAAyE;QACzE,IAAI,QAAQ,SACT,IAAI,CAAC,YACL,MAAM,CAAC,8CACP,EAAE,CAAC,gBAAgB,QACnB,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM;QAE1C,IAAI,SAAS,UAAU;YACrB,QAAQ,MAAM,GAAG,CAAC,cAAc,QAAQ,QAAQ;QAClD;QACA,IAAI,SAAS,QAAQ;YACnB,QAAQ,MAAM,GAAG,CAAC,cAAc,QAAQ,MAAM;QAChD;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM;QAE9B,IAAI,OAAO,MAAM;QACjB,OAAO;IACT;AACF;AAEO,eAAe,cAAc,OAAwB;IAC1D,MAAM,WAAW,IAAA,yIAAY;IAC7B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CAAC,SACP,MAAM,CAAC,0DACP,MAAM;IAET,IAAI,OAAO,MAAM;IACjB,OAAO;AACT;AAEO,eAAe,cAAc,SAAiB,EAAE,OAAwB;IAC7E,MAAM,WAAW,IAAA,yIAAY;IAC7B,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CAAC;QAAE,GAAG,OAAO;QAAE,YAAY,IAAI,OAAO,WAAW;IAAG,GAC1D,EAAE,CAAC,MAAM,WACT,MAAM,CAAC,0DACP,MAAM;IAET,IAAI,OAAO,MAAM;IACjB,OAAO;AACT;AAEO,eAAe,cAAc,SAAiB;IACnD,OAAO,cAAc,WAAW;QAAE,QAAQ;IAAY;AACxD;AAEO,eAAe,eAAe,SAAiB,EAAE,WAAoB;IAC1E,MAAM,UAA2B;QAAE,QAAQ;IAAY;IACvD,IAAI,gBAAgB,WAAW;QAC7B,QAAQ,YAAY,GAAG;IACzB;IACA,OAAO,cAAc,WAAW;AAClC"}}]
}